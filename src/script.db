create table public.ambientes (
  id uuid not null default gen_random_uuid (),
  nome text not null,
  constraint ambientes_pkey primary key (id)
) TABLESPACE pg_default;

create table public.checklist_itens (
  id bigint generated by default as identity not null,
  ambiente_id uuid not null,
  categoria text not null,
  descricao text not null,
  constraint checklist_itens_pkey primary key (id),
  constraint checklist_itens_ambiente_id_fkey foreign KEY (ambiente_id) references ambientes (id)
) TABLESPACE pg_default;

create table public.clientes (
  id uuid not null default extensions.uuid_generate_v4 (),
  nome text not null,
  telefone text null,
  email text null,
  criado_em timestamp with time zone null default now(),
  constraint clientes_pkey primary key (id)
) TABLESPACE pg_default;

create table public.empreendimentos (
  id uuid not null default extensions.uuid_generate_v4 (),
  nome text not null,
  endereco text not null,
  criado_em timestamp with time zone null default now(),
  created_at timestamp with time zone not null default timezone ('utc'::text, now()),
  cliente text null,
  constraint empreendimentos_pkey primary key (id)
) TABLESPACE pg_default;

create index IF not exists idx_emp_nome on public.empreendimentos using btree (nome) TABLESPACE pg_default;

create table public.engenheiros (
  id uuid not null default extensions.uuid_generate_v4 (),
  nome text not null,
  crea text not null,
  telefone text null,
  criado_em timestamp with time zone null default now(),
  constraint engenheiros_pkey primary key (id),
  constraint engenheiros_crea_key unique (crea)
) TABLESPACE pg_default;

create table public.fotos_vistoria (
  id uuid not null default extensions.uuid_generate_v4 (),
  item_id uuid not null,
  storage_path text not null,
  tipo public.tipo_foto not null,
  criado_em timestamp with time zone null default now(),
  constraint fotos_vistoria_pkey primary key (id),
  constraint fotos_vistoria_item_id_fkey foreign KEY (item_id) references itens_vistoria (id) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists idx_fotos_item on public.fotos_vistoria using btree (item_id) TABLESPACE pg_default;

create table public.itens_vistoria (
  id uuid not null default extensions.uuid_generate_v4 (),
  vistoria_id uuid not null,
  checklist_item_id uuid null,
  ambiente_id uuid null,
  numero_item integer not null,
  descricao_defeito text null,
  observacao_interna text null,
  status public.status_item not null default 'pendente'::status_item,
  item_original_id uuid null,
  criado_em timestamp with time zone null default now(),
  constraint itens_vistoria_pkey primary key (id),
  constraint itens_vistoria_vistoria_id_numero_item_key unique (vistoria_id, numero_item),
  constraint itens_vistoria_item_original_id_fkey foreign KEY (item_original_id) references itens_vistoria (id),
  constraint itens_vistoria_vistoria_id_fkey foreign KEY (vistoria_id) references vistorias (id) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists idx_itens_vistoria on public.itens_vistoria using btree (vistoria_id) TABLESPACE pg_default;


create table public.unidades (
  id uuid not null default extensions.uuid_generate_v4 (),
  empreendimento_id uuid not null,
  cliente_id uuid null,
  codigo text not null,
  andar integer null,
  criado_em timestamp with time zone null default now(),
  created_at timestamp with time zone not null default timezone ('utc'::text, now()),
  constraint unidades_pkey primary key (id),
  constraint unidades_empreendimento_id_codigo_key unique (empreendimento_id, codigo),
  constraint unidades_cliente_id_fkey foreign KEY (cliente_id) references clientes (id),
  constraint unidades_empreendimento_id_fkey foreign KEY (empreendimento_id) references empreendimentos (id) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists idx_unidades_emp on public.unidades using btree (empreendimento_id) TABLESPACE pg_default;

create table public.vistorias (
  id uuid not null default extensions.uuid_generate_v4 (),
  unidade_id uuid not null,
  engenheiro_id uuid not null,
  vistoria_pai_id uuid null,
  data_vistoria date not null,
  status public.status_vistoria not null default 'pendente'::status_vistoria,
  observacoes text null,
  criado_em timestamp with time zone null default now(),
  constraint vistorias_pkey primary key (id),
  constraint vistorias_engenheiro_id_fkey foreign KEY (engenheiro_id) references engenheiros (id),
  constraint vistorias_unidade_id_fkey foreign KEY (unidade_id) references unidades (id) on delete CASCADE,
  constraint vistorias_vistoria_pai_id_fkey foreign KEY (vistoria_pai_id) references vistorias (id)
) TABLESPACE pg_default;

create index IF not exists idx_vistorias_unidade on public.vistorias using btree (unidade_id) TABLESPACE pg_default;